def Stage_Name="Init"
def ENV
def releaseVersion
def bom
def tenantId = "base"
def applicationId ="icargo-neo"
def currentVersion
def jiraIds

env.EMAIL_SUBSCRIBERS="sinoob.saithumuhammed@ibsplc.com,Sander.Joseph@ibsplc.com,anjana.narayanan@ibsplc.com,jesin.zachariah@ibsplc.com,jiji.joseph@ibsplc.com,jojeet.philip@ibsplc.com,Lakshmi.Ramachandran@ibsplc.com,leena.joseph@ibsplc.com,Santhi.Kaimala@ibsplc.com,shinu.john@ibsplc.com,Arun.Padinhare@ibsplc.com,arun.thomas@ibsplc.com,aswin.ravikumar@ibsplc.com,bejoy.kunjumon@ibsplc.com,binish.prabhakaran@ibsplc.com,freddy.kurien@ibsplc.com,hari.reddy@ibsplc.com,jayakrishnan.jayaram@ibsplc.com,jens.parappallil@ibsplc.com,juby.mathew@ibsplc.com,Kannan.Muraleedharan@ibsplc.com,kashyap.prakasan@ibsplc.com,lakshmi.narayanan@ibsplc.com,manoj.balan@ibsplc.com,manu.purushothaman@ibsplc.com,manu.raghavan@ibsplc.com,philip.scaria@ibsplc.com,Remya.Mathew@ibsplc.com,rony.john@ibsplc.com,sharika.narayanankutty@ibsplc.com,sooraj.sadasivanpillai@ibsplc.com,Vijayakumar.Ramasamy@ibsplc.com,vivek.radhakrishnan@ibsplc.com,Akshaya.Raj@ibsplc.com,Arathy.Sathy@ibsplc.com,Arjun.Villadath@ibsplc.com,Arya.Geetha@ibsplc.com,Gokul.Gopinathpillai@ibsplc.com,Jisha.Joshi@ibsplc.com,Pallabi.Nath@ibsplc.com,Preethi.Lalitha@ibsplc.com,rajani.chandran@ibsplc.com,Rinimol.Ramdas@ibsplc.com,Sandra.Thadathil@ibsplc.com,Shabab.Erkkara@ibsplc.com,Tresa.Jayan@ibsplc.com,raji.prakash@ibsplc.com"


pipeline {
    agent any

	options {
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '1'))
    }
		
   parameters {
        text(defaultValue: "iCO_5.0.7.7100", description: 'The version we plan to deploy to the environment', name: 'releaseVersion')
    }
	
    stages {			
		
		stage("Deploy Phase") {			
			steps {
				echo "Deploy Phase"
				echo " The Deployment is for ${envToBeDeployed}"
				sh '''
					if [ -e ${WORKSPACE}/bom.yaml ]; then
							echo "---- >Deleting bom ---  "
							rm  ${WORKSPACE}/bom.yaml
					fi
				'''
				script {
                	env.HELM_TMOUT_DEFAULT="600s"
					Stage_Name='Deploy'
                    env.RELVER=releaseVersion
                    echo "ReleaseVersion is ${env.releaseVersion}"
					env.GETURL="http://10.246.12.51:5000/release-manager-service/rest/api/builds/"+env.releaseVersion+"/bom"
					bom = ["curl","-o","${WORKSPACE}/bom.yaml" ,"-X", "GET", "-H", "Content-Type: application/json","-H", "Accept: application/yaml", "${env.GETURL}"].execute().text
				}
				dir("icargo-neo-cli"){
					sh"pwd"
					sh '''
						export ENABLE_COLOR=false
						./iconctl.sh deploy-full ${envToBeDeployed} ${WORKSPACE}/bom.yaml
					'''					
				}
			}
		}
	
		
	}

	
	post {
		success{
			script {
				emailext( 
						attachmentsPattern: "icargo-neo-cli/demo.zip,bom.yaml",
						recipientProviders: [[$class: 'CulpritsRecipientProvider'],
								[$class: 'RequesterRecipientProvider'],
								[$class: 'DevelopersRecipientProvider']],
						mimeType: 'text/html',
						to : "${env.EMAIL_SUBSCRIBERS}",
                        subject: "Success: Job '${env.JOB_NAME} [${env.RELVER}]'",
                        body: """Success: Job '${env.JOB_NAME} [${env.RELVER}]':
							<br />
							Check console output at:  ${env.BUILD_URL}/console 
							<br />
							Job Name:  ${env.JOB_NAME} 
                            Release Version: ${env.RELVER}
							<br />
							Jenkins Build Number: [${env.BUILD_NUMBER}]"""             
                    )
                    
			}
			
			sh '''
				if [ -e ${WORKSPACE}/bom.yaml ]; then
					rm  ${WORKSPACE}/bom.yaml
				fi
				
				if [ -e ${WORKSPACE}/icargo-neo-cli/demo.zip ]; then
					rm  ${WORKSPACE}/icargo-neo-cli/demo.zip
				fi
				
				'''
			
	}
	
        failure {
            script {
				emailext(
						attachmentsPattern: "icargo-neo-cli/demo.zip",
						mimeType: 'text/html',
						recipientProviders: [[$class: 'CulpritsRecipientProvider'],
										[$class: 'RequesterRecipientProvider'],
										[$class: 'DevelopersRecipientProvider']],
						to : "${env.EMAIL_SUBSCRIBERS}",
						subject: "FAILURE: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
						body: """
								<div style="color:red;font-size:20px">
								FAILURE: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]':
								</div>
								Failure happened in ${Stage_Name}.
								<br />
								Check console output at:  ${env.BUILD_URL}/console
								<br />
								Job Name:  ${env.JOB_NAME} 
								<br />
								Build Number: [${env.BUILD_NUMBER}]"""
						)				
            }
        }
    }

}
